# R语言编程基础 

R语言是一种通用的统计计算和数据可视化开源软件环境和编程语言，具有高度可扩展性。R语言同时支持Linux、Windows和Mac操作系统。R语言的前身为贝尔实验室研发的S语言。1992年由新西兰奥克兰大学的Ross Ihaka和Robert Gentleman创建，并以他们的名字首字母作为项目名称。2007年Revolution Analytics公司成立，对R语言做商用支持，2015年1月被Microsoft收购。

1997年，R语言正式开源，吸引了世界范围内各行业的代码贡献者，实现各种各样的数据分析方法。截至2018年11月，CRAN（The Comprehensive R Archive Network）官方收录了13328个算法库，常用的包括：

- 数据加载：RODBC，RMySQL，RSQLite，XLConnect，xlsx，foreign；
- 数据处理：dplyr，tidyr，stringr，lubridate；
- 数据可视化：ggplot2，ggvis，rgl，htmlwidgets，googleVis；
- 数据建模：car，mgcv，nlme，randomForest，multcomp，glmnet，survival，caret，mlr；
- 数据报告：shiny，xtable；
- 空间数据：sp，maptools，maps，ggmap；
- 时间序列和金融数据：zoo，xts，quantmod；
- 高性能计算：Rcpp，data.table，parallel；
- 网页数据：XML，jsonlite，httr。

## R语言的安装与运行

### 1.R语言的安装、启动和退出

R语言可以从官网https://www.r-project.org/下载，选出适合用户操作系统的二进制发行版后，按提示一步一步进行安装。

RStudio是R语言的一个集成开发环境（IDE），可以从官网https://www.rstudio.com/下载并安装。双击启动RStudio，左侧`Console`区域为控制台，可进行交互式编程。RStudio的主界面如图@ref(fig:f1)所示。

![image-20201020185122370](/Users/wangchenming/Library/Application Support/typora-user-images/image-20201020185122370.png)

用户可以在控制台的命令提示符“>”后键入R语言的命令，如`plot(rnorm(1000))`，并回车，可以看到在右下角输出相应统计图，如图所示。

```R
plot(rnorm(1000))
```

![image-20201020185226573](/Users/wangchenming/Library/Application Support/typora-user-images/image-20201020185226573.png)

需要退出R语言时，可以在控制台键入命令`q()`并回车，或直接点击关闭按钮。退出时可选择保存工作空间, 缺省文件名为R安装目录的`bin`子目录下的R.RData。

### 2.R语言程序包的安装和使用

R语言程序包的安装有以下几种方式：

- 命令方式：在联网情况下，在控制台键入命令`install.packages("<程序包名>)`；
- 菜单方式：选择菜单栏“Tools”中的“Install Packages..”，并在弹窗中的“Install from:”选择“ Repository (CRAN, CRANextra)”；
- 本地安装：同上，在弹窗中的“Install from:”选择“Package Archive File (.zip; .tar.gz)”。

需要使用R语言程序包时，用户在控制台键入命令`library(<程序包名>)`。

```R
install.packages("")
library()
```

### 3.R语言帮助

对函数的用法有疑问时，用户可以在控制台键入命令`?<函数名>`或`help(<函数名>)`，如`?rnorm`，查看R语言的函数帮助，帮助信息会在右下角显示，如图所示。

```R
?rnorm
```

![image-20201020185933907](/Users/wangchenming/Library/Application Support/typora-user-images/image-20201020185933907.png)

## 对象与属性

### 1.赋值和显示

R语言中做赋值可以使用符号`<-`或`->`，还可以使用等号`=`但很少使用，因为R语言的前身仅支持前者。 可以直接使用对象名或调用函数`print()`显示对象内容。

```R
n<-10
n
10->n
n
print(n)
n=10
n
```

### 2.基本数据类型

R语言中所有的对象都有两个内在属性：类型和长度。类型是对象的基本种类，主要有以下4种：

- 数值型，包括：整型、单精度实型、双精度实型；
- 字符型；
- 复数型；
- 逻辑型（`TRUE`、`FALSE`或`NA`）。

调用函数`mode()`返回对象的类型。

调用函数`length()`返回对象的长度。

```R
x <- 1
mode(x)
length(x)
A <- "Gomphotherium"
mode(A)
length(A)
compar <- TRUE
mode(compar)
z <- 1i
mode(z)
```

### 3.特殊数值型

`Inf`和`-Inf`分别表示∞∞和−∞−∞。

```R
x<-5/0
x
exp(x)
exp(-x)
```

`NaN`表示不是数字的值（Not a Number）。

```R
Inf-Inf
0/0
sqrt(-7)
```

### 4.字符型

输入字符型变量时，既可以用双引号也可以用单引号：

- 方法一：加上双引号`"`，如果内容包含双引号则让它跟在反斜杠`\`后；
- 方法二：加上单引号`'`，如果内容包含单引号则让它跟在反斜杠`\`后。

```R
x <- "Double quotes \" delimitate R's strings."
x
cat(x)
x <- 'Double quotes " delimitate R\'s strings.'
x
```

## 向量

R语言中各种数据对象与其支持的类型如表所示。

| 对象         | 类型                           | 是否允许同一个对象中有多种类型 |
| ------------ | ------------------------------ | ------------------------------ |
| 向量         | 数值型，字符型，复数型，逻辑型 | 否                             |
| 因子（向量） | 数值型，字符型                 | 否                             |
| 数组         | 数值型，字符型，复数型，逻辑型 | 否                             |
| 矩阵         | 数值型，字符型，复数型，逻辑型 | 否                             |
| 数据框       | 数值型，字符型，复数型，逻辑型 | 是                             |
| 时间序列     | 数值型，字符型，复数型，逻辑型 | 否                             |
| 列表         | 数值型，字符型，复数型，逻辑型 | 是                             |

在R语言的各种数据结构中，首先我们讨论向量。向量是R语言中最常用、最基本的对象，可用于表示数据集中一个变量的取值。

### 1.向量创建

调用函数`c()`将值合并成一个向量。

```R
x <- c(1,2,5,8,3)
x
```

调用函数`sep()`或运算符`:`产生一个序列，其中

- 第1个参数`from`表示序列的起始值；
- 第2个参数`to`表示序列的终止值；
- 第3个参数`by`表示序列的步长值；
- 第4个参数`length.out`表示序列的长度，即元素数。

```R
1:10
seq(1,5,by=0.5)
seq(1,10,length.out = 11)
```

调用函数`rep()`重复向量元素，其中

- 第1个参数`x`表示需重复的向量；
- 第2个参数`times`表示重复次数；
- 第3个参数`length.out`表示输出向量的长度；
- 第4个参数`each`表示每个向量元素重复次数。

```R
rep(2:5,times=2)
rep(2:5,times=1:4)
rep(1:3,times=4,each=3)
```

调用函数`paste()`连接字符型向量，其中

- 前1个或多个参数`...`表示需连接的字符型向量；
- 参数`sep`表示连接字符串。

```R
x<-c("a","b")
paste(x,1:10,sep=".")
```

逻辑型向量可以由向量做条件判断得到，长度与原向量相同。在普通运算中，逻辑向量会被转化为数值型向量，`TRUE`作为1，`FALSE`作为0。

```R
x <- c(10.4, 5.6, 3.1, 6.4, 21.7)
x>13
(7!=6)==1
```

因子型向量用于表示数据集中类别变量的取值。

调用函数`factor()`将数值型或字符型向量转化为因子型向量，其中

- 第1个参数`x`表示需转化的向量，通常仅有少量独立值；
- 第2个参数`levels`表示因子型向量的级别，即向量`x`可能的取值，默认值为向量`x`独立值按升序排列的集合。

```R
a <- c("green", "blue", "green", "yellow")
factor(a)
b <- c(1,2,3,1)
factor(b)
factor(b,levels=1:4)
```

### 2.向量运算

向量运算是按照元素一个一个进行的。如果同一个表达式中的向量长度不同，则遵循循环法则，即表达式结果的长度为其中最长向量的长度，表达式中较短的向量会重复使用若干次（不一定是整数次），直到与最长向量的长度匹配。

在以下例子中可以看出，结果向量`v`长度与向量`y`一致为11，向量`x`被重复了2.2次。

```R
x <- c(10.4, 5.6, 3.1, 6.4, 21.7)
y <- c(x,0,x)
v <- 2*x    + y    + 1
v
```

除了以上例子中的加法运算，还支持表2中的数学运算符、表3中的比较运算符和表4中的逻辑运算符：

数学运算符

| 符号 | 运算 |
| ---- | ---- |
| +    | 加法 |
| -    | 减法 |
| *    | 乘法 |
| /    | 除法 |
| ^    | 乘方 |
| %%   | 取模 |
| %/%  | 整除 |

逻辑运算符

| 符号 | 运算       |
| ---- | ---------- |
| <    | 小于       |
| >    | 大于       |
| <=   | 小于或等于 |
| >=   | 大于或等于 |
| ==   | 等于       |
| !=   | 不等于     |

比较运算符

| 符号      | 运算   |
| --------- | ------ |
| ! x       | 逻辑非 |
| x & y     | 逻辑与 |
| x && y    | 逻辑与 |
| x         | y      |
| x         |        |
| xor(x, y) | 异或   |

对于向量，数据分析中有如表5中的函数实现常用统计功能：

| 函数                       | 功能                 |
| -------------------------- | -------------------- |
| max(x)和min(x)             | 最大和最小的元素     |
| which.max(x)和which.min(x) | 最大和最小元素的索引 |
| mean(x)                    | 均值                 |
| median(x)                  | 中位数               |
| var(x)                     | 方差                 |
| sd(x)                      | 标准差               |
| range(x)                   | 范围                 |
| IQR(x)                     | 四分位数极差         |
| quantile(x)                | 常用分位数           |
| summary(x)                 | 常用描述统计量       |
| sum(x)                     | 总和                 |
| prod(x)                    | 乘积                 |
| rev(x)                     | 逆序                 |
| sort(x)                    | 排序                 |
| var(x)和cov(x)             | 协方差               |
| cor(x)                     | 相关系数             |

```R
x <- c(10.4, 5.6, 3.1, 6.4, 21.7, 7.8, 18.2, 17.3)
max(x)
which.max(x)
mean(x)
median(x)
var(x)
sd(x)
range(x)
summary(x)
sum(x)
sort(x)
```

### 3.向量切片

向量切片，即选取向量的子集，可以通过在其名称后追加一个方括号`[]`中的索引向量完成，具体有以下几种方法：

- 方法一：正整数索引向量，即选取这些索引对应的元素，需要注意的是，与Python不同，R语言的索引从1而不是0开始；

```R
x <- c(10.4, 5.6, 3.1, 6.4, 21.7, 7.8, 18.2, 17.3)
x[3]
x[1:5]
x[c(1,4)]
```

* 方法二：负整数索引向量，即排除这些索引对应的元素，需要注意的是，与Python不同，R语言的负索引表示排除而不是从末尾开始；

```R
x <- c(10.4, 5.6, 3.1, 6.4, 21.7, 7.8, 18.2, 17.3)
x[-3]
x[-(1:5)]
x[c(-1,-4)]
```

* 方法三：字符型索引向量，即选取这些名称对应的元素，仅限于有`names`属性的向量；
    - 调用函数`names()`返回或设置向量的`names`属性；

```R
x <- c(10.4, 5.6, 3.1, 6.4, 21.7, 7.8, 18.2, 17.3)
names(x) <- c("a","b","c","d","e","f","g","h")
x[c("a","d")]
```

* 方法四：逻辑型索引向量，即选取逻辑值为真对应的元素。

```R
x <- c(10.4, 5.6, 3.1, 6.4, 21.7, 7.8, 18.2, 17.3)
x[x>10]
x[x>10&x<15]
```

## 数组和矩阵

### 1.数组和维度

数组（array）是一个𝑘k维的数据表。矩阵（matrix）是数组的一个特例，即维数𝑘=2k=2；向量也是数组的一个特例，即维数𝑘=1k=1。数组、矩阵和向量中的元素必须是同一类型的。数组和矩阵除了有类型和长度属性外，还有维度（`dim`）属性。

调用函数`array()`创建数组，其中

- 第1个参数`data`表示数组的数据向量；
- 第2个参数`dim`表示数组的维度；
- 第3个参数`dimnames`表示各维度的名称。

```R
A <- array(1:8, dim = c(2, 2, 2))
A
```

调用函数`dim()`设置向量的`dim`属性，也可以创建数组。

```R
A <- 1:8
dim(A) = c(2, 2, 2)
A
```

### 2.矩阵

矩阵是数组的特例，可以调用函数`array()`创建矩阵。

```R
A <- array(1:6, dim = c(2, 3))
A
A<-array(1:4,c(2,3))
A
```

由于矩阵在数学和统计中的特殊性，通常调用函数`matrix()`创建矩阵，其中

- 第1个参数`data`表示矩阵的数据向量；
- 第2个参数`nrow`表示矩阵的行数；
- 第3个参数`nrow`表示矩阵的列数；
- 第4个参数`byrow`表示是否按行填充，默认为否；
- 第5个参数`dimnames`表示各维度的名称。

```R
X <- matrix(1, nr = 2, nc = 2)
X
X <- matrix(1:4, 2, 2)
X
X <- matrix(1:6, nrow = 2, ncol = 3)
X
X <- matrix(1:6, nrow = 2, ncol = 3, byrow=TRUE)
X
```

### 3.矩阵切片

矩阵切片与向量切片类似，可以通过正整数、负整数、字符型和逻辑型选取或排除若干元素、行或列。与向量切片不同的是，方括号中有2个以逗号分隔的元素，第1个元素表示行索引，第2个元素表示列索引。

```R
X <- matrix(1:6, nrow = 2, ncol = 3)
X[2,2]
X[2,]
X[,2]
X[-1,]
```

### 4.矩阵运算

调用函数`t()`得到矩阵的转置。

```R
X <- matrix(1:6, 2, 2)
X
t(X)
```

调用函数`diag()`得到矩阵的对角线元素。

```R
X <- matrix(1:4, 2, 2)
diag(A)
```

调用函数`rbind()`和函数`cbind()`按矩阵的行和按列合并.

```R
m1 <- matrix(1:4, 2, 2)
m2 <- matrix(5:8, 2, 2)
m1
m2
rbind(m1, m2)
cbind(m1, m2)
```

需要注意区分矩阵的按元素乘积和矩阵乘积：

- 符号`*`用于按元素乘积；
- 符号`%*%`用于矩阵乘积。

```R
m1*m2
m1%*%m2
```

### 5.数组按行和按列计算

调用函数`apply()`按行和按列计算，其中

- 第1个参数`X`表示需要计算的数组；
- 第2个参数`MARGIN`对于矩阵而言，1表示按行计算，2表示按列计算；
- 第3个参数`FUN`表示计算函数。

```R
X <- matrix(1:6, nrow = 2, ncol = 3)
apply(X, MARGIN = 1, FUN = mean)
apply(X, MARGIN = 2, FUN = mean)
```

虽然函数`apply()`的功能完全可以通过循环迭代实现，但调用该函数可以使得代码更紧凑和易读，因此极力推荐。

## 数据框

### 1.数据框创建

数据分析中的数据集通常由若干变量和样本组成，在R语言中由数据框表示。数据框的列表示数据集的变量（字段、属性），行表示样本（观测值）。数据框与之前介绍的矩阵和二维数组类似，维数𝑘=2k=2，且每个变量（列）的样本长度相同。与矩阵不同的是，每个变量（列）的数据类型可以不同。

调用函数`data.frame()`创建数据框，其中

- 前1个或多个参数`...`形如`<值>`或`<标签>=<值>`，表示变量名称和对应的数据。

```R
x=c(42,7,64,9)
y=1:4
df=data.frame(index = y, value = x)
df
```

### 2.数据框运算

上一节中介绍的函数`max()`、`min()`、`median()`、`var()`、`sd()`、`sum()`、`cov()`、`cor()`和`summary()`同样适用于数据框。

调用函数`summary()`显示常用描述统计量，其中`iris`为R语言内置数据集，在后面章节会具体介绍。

```R
summary(iris)
```

### 3.数据框切片

数据框切片与向量和矩阵切片类似，不同的是，对列操作可以使用变量名称。

- 选取数据框的单个元素；

  ```R
  iris[1, 1]
  ```

  选取数据框的子集；

  - 使用行号（向量）和列号（向量）；
  - 如果省略行号（列号），则表示选取所有行（列）；
  - 使用变量名（向量）选取相应列；

  ```R
  iris[c(1, 5), c(1, 3)]
  iris[c(1, 5), ]
  iris[c(1, 5), c("Sepal.Length", "Petal.Length")]
  ```

  - 使用形如`<数据框>$<变量>`选取数据框的一列；

  ```R
  iris$Sepal.Length
  ```

  - 选取满足条件的样本。

  ```R
  iris[iris$Sepal.Length > 5.5 & iris$Species == "setosa", ]
  ```

  ### 4.数据框增加新变量

  可以直接赋值给`<数据框>$<新变量>`增加新变量。

  ```R
  iris$Petal.Sum <- iris$Petal.Length    + iris$Petal.Width
  summary(iris)
  ```

## 列表

复杂的数据分析中，仅有向量、矩阵和数据框还不够，R语言中的的列表（list）可以包含任何类型且长度不同的对象。

调用函数`list()`创建列表，其中

- 前1个或多个参数`...`形如`<值>`或`<标签>=<值>`，表示对象名称和对应的数据，其中各个对象的长度可以不一致。

```R
L <- list(x = 1:6, y = matrix(1:4, nrow = 2))
L
```

## 数据的存储与读取

R语言是一个开放的软件编程环境，支持与各种文本文件、数据库和R语言自带的数据格式交互，做数据的存储与读取。

R语言中一般用数据框表示数据集。创建一个数据框，之后的步骤都以存储该数据框为例。

```R
df <- data.frame(obs = c(1, 2, 3), treat = c("A", "B", "A"), weight = c(2.3, NA, 9))
df
```

### 1.数据存储

最基本的数据格式为文本文件。

调用函数`write.table()`将数据框保存为简单的文本文件，其中

- 第1个参数`x`表示需要保存的对象，通常为矩阵或数据框；
- 第2个参数`file`表示保存路径和文件名；
- 第3个参数`append`表示是否追加写入文件，默认为否；
- 第4个参数`quote`表示字符型数据是否要用双引号，默认为是；
- 第5个参数`sep`表示变量的分隔符，默认为空格；
- 参数`row.names`表示是否要写入行名称，默认为是；
- 参数`col.names`表示是否要写入列名称，默认为是。

```R
write.table(df, file = "/opt/foo.txt", row.names = FALSE, quote = FALSE)
```

打开文件`/opt/foo.txt`查看内容。

obs treat weight 1 A 2.3 2 B NA 3 A 9

调用函数`write.csv()`将数据框保存为**逗号分隔**的文本文件，其中

- 参数`sep`表示变量的分隔符，默认为逗号；
- 其他参数与函数`write.table()`一致。

```R
write.csv(df, file = "/opt/foo.csv", row.names = FALSE, quote = FALSE)
```

打开文件`/opt/foo.csv`查看内容。

obs,treat,weight 1,A,2.3 2,B,NA 3,A,9

R语言还有自带的数据格式，以`.Rdata`作为后缀。

调用函数`save()`将数据框保存为R语言格式文件，其中

- 前1个或多个参数`...`表示需要保存的对象；
- 参数`file`表示保存路径和文件名。

```R
save(df, file = "/opt/foo.Rdata")
```

### 2.数据读取

与数据存储的函数`write.table()`、`write.csv()`和`save()`相对应的，是一组数据读取的函数`read.table()`、`read.csv()`和`load()`。

调用函数`read.table()`将文本文件中的数据读取为数据框，其中

- 第1个参数`file`表示读取路径和文件名；
- 第2个参数`header`表示文本文件是否在第一行包含变量名，默认为否；
- 第3个参数`sep`表示变量的分隔符，默认为空格。

```R
df2 <- read.table(file = "/opt/foo.txt", header = TRUE)
df2
```

函数`read.csv()`与函数`read.table()`类似，区别为默认分隔符为逗号。

调用函数load()读取 R 语言格式文件，其中

- 第1个参数`file`表示读取路径和文件名。

```R
load(file = "/opt/foo.Rdata")
```

除了外部文件，R语言的程序包中还会有一些内置数据集。

调用函数`data()`读取内置数据集，其中

- 前1个或多个参数`...`表示需要读取的数据集；
- 参数`package`表示数据集所属的程序包。

```R
data(mpg, package="ggplot2")
summary(mpg)
```

